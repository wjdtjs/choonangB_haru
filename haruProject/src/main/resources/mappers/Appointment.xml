<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.haruProject.AppointmentMapper">

	<!-- select -->
	<!-- 전체 예약 수 조회 -->
	<select id="HR_SelectTotalAppointmentCnt" parameterType="SearchItem" resultType="int">
		SELECT COUNT(*) 
		FROM APPOINTMENT a
			JOIN MEMBER m ON a.MEMNO = m.MEMNO
		    JOIN PET p ON a.PETNO = p.PETNO
		    JOIN ADMIN d ON a.ANO = d.ANO
		    JOIN MEDICAL_ITEM t ON a.MCODE = t.MCODE
		    JOIN COMMON c ON c.BCD = a.RSTATUS_BCD and c.MCD = a.RSTATUS_MCD
		    JOIN COMMON cm ON cm.BCD = t.MTITLE_BCD and cm.MCD = t.MTITLE_MCD		    
		    
		WHERE 1=1
		    <if test="type4 != null and type4 != 0">
		        AND a.rstatus_mcd = #{type4}
		    </if>
		    <if test="type5 != null and type5 != 0">
		        <choose>
		            <when test="type5 == 100">AND a.RESNO LIKE '%' || #{search1} || '%'</when>
		            <when test="type5 == 200">AND m.MNAME LIKE '%' || #{search1} || '%'</when>
		            <when test="type5 == 300">AND p.PETNAME LIKE '%' || #{search1} || '%'</when>
		            <when test="type5 == 400">AND d.ANAME LIKE '%' || #{search1} || '%'</when>
		            <when test="type5 == 500">AND cm.CONTENT LIKE '%' || #{search1} || '%'</when>
		        </choose>
		    </if>

	</select>
	 
	<!-- 예약 목록 가져오기 -->
	<select id="HR_SelectAppointmentList" parameterType="Map" resultType="Appointment">
		SELECT *
		FROM (
		    SELECT ROWNUM rn, aa.*
		    FROM (
		        SELECT a.RESNO, a.RDATE, m.MNAME, p.PETNAME, d.ANAME, c2.CONTENT as item, c1.CONTENT as status, a.rstatus_mcd, c3.CONTENT as species, c4.CONTENT as gender, a.start_time
		        FROM APPOINTMENT a 
		            JOIN MEMBER m ON a.MEMNO = m.MEMNO
		            JOIN PET p ON a.PETNO = p.PETNO
		            JOIN ADMIN d ON a.ANO = d.ANO
		            JOIN MEDICAL_ITEM t ON a.MCODE = t.MCODE
		            JOIN COMMON c1 ON c1.BCD = a.RSTATUS_BCD and c1.MCD = a.RSTATUS_MCD			<!-- 예약 상태 -->
		            JOIN COMMON c2 ON c2.BCD = t.MTITLE_BCD and c2.MCD = t.MTITLE_MCD			<!-- 진료 항목 -->
		            JOIN COMMON c3 ON c3.BCD = p.PETSPECIES_BCD and c3.MCD = p.PETSPECIES_MCD	<!-- 종 -->
		            JOIN COMMON c4 ON c4.BCD = p.PETGENDER_BCD and c4.MCD = p.PETGENDER_MCD		<!-- 성별 -->
		           
				WHERE 1=1
				    <if test="type4 != null and type4 != 0">
				        AND a.rstatus_mcd = #{type4}
				    </if>
				    <if test="type5 != null and type5 != 0">
				        <choose>
				            <when test="type5 == 100">AND a.RESNO LIKE '%' || #{search1} || '%'</when>
				            <when test="type5 == 200">AND m.MNAME LIKE '%' || #{search1} || '%'</when>
				            <when test="type5 == 300">AND p.PETNAME LIKE '%' || #{search1} || '%'</when>
				            <when test="type5 == 400">AND d.ANAME LIKE '%' || #{search1} || '%'</when>
				            <when test="type5 == 500">AND cm.CONTENT LIKE '%' || #{search1} || '%'</when>
				        </choose>
				    </if>
							        
				ORDER BY a.REG_DATE desc
		    )aa
		)
		WHERE rn BETWEEN #{startRow} AND #{endRow} 
	</select>
	
	
	<select id="HR_SelectAppointmentDetail" parameterType="String" resultType="Appointment">
		SELECT a.resno, a.rdate, c1.content as item, d.aname, m.mname, p.petno, p.petname, c2.content as species, c3.content as gender, p.petweight, c4.content as status, a.memo, a.rstatus_mcd
		FROM APPOINTMENT a
		    JOIN ADMIN d ON a.ano = d.ano
		    JOIN MEMBER m ON a.memno = m.memno
		    JOIN MEDICAL_ITEM t ON a.mcode = t.mcode
		    JOIN PET p ON a.petno = p.petno
		    JOIN COMMON c1 ON c1.bcd = t.mtitle_bcd AND c1.mcd = t.mtitle_mcd
		    JOIN COMMON c2 ON c2.bcd = p.PETSPECIES_BCD AND c2.mcd = p.PETSPECIES_MCD
		    JOIN COMMON c3 ON c3.bcd = p.PETGENDER_BCD AND c3.mcd = p.PETGENDER_MCD
		    JOIN COMMON c4 ON c4.bcd = a.RSTATUS_BCD AND c4.mcd = a.RSTATUS_MCD
		WHERE a.resno = #{resno}
	</select>
	
	
	
	<!-- 전체 진료 수 조회 -->
	<select id="HR_SelectTotalConsultationCnt" parameterType="SearchItem" resultType="int">
		SELECT COUNT(*)
		FROM appointment a
			LEFT OUTER JOIN CHART ch ON a.RESNO = ch.RESNO
		WHERE  a.rstatus_mcd = 400
		<if test="(type4 != null and type4 != 0)">
			 <choose>
			 	<when test="type4 == 100">
			 		AND a.resno = ch.resno
			 	</when>
			 	<when test="type4 == 200">
			 		AND ch.resno IS NULL
			 	</when>
			 </choose>
		</if>
	</select>
	
	
	<!-- 진료 내역 가져오기 -->
	<select id="HR_SelectConsultationList" parameterType="Map" resultType="Appointment">
		SELECT *
		FROM (
		    SELECT ROWNUM rn, cc.*
		    FROM (
		        SELECT a.RESNO, ch.RESNO as cresno, a.RDATE, a.START_TIME, m.MNAME, p.PETNAME, cm1.CONTENT as species, ad.ANAME, cm2.CONTENT as item, a.rstatus_mcd
                FROM APPOINTMENT a
                    JOIN MEMBER m ON a.MEMNO = m.MEMNO
                    JOIN PET p ON a.PETNO = p.PETNO
                    JOIN ADMIN ad ON a.ANO = ad.ANO
                    JOIN MEDICAL_ITEM t ON a.MCODE = t.MCODE
                    JOIN COMMON c ON a.RSTATUS_BCD = c.BCD AND a.RSTATUS_MCD = c.MCD
                    JOIN COMMON cm1 ON cm1.BCD = p.PETSPECIES_BCD AND cm1.MCD = p.PETSPECIES_MCD
                    JOIN COMMON cm2 ON cm2.BCD = t.MTITLE_BCD AND cm2.MCD = t.MTITLE_MCD
                    
                    -- 차트 존재 여부 확인
                    LEFT OUTER JOIN CHART ch ON a.RESNO = ch.RESNO
                WHERE a.RSTATUS_MCD = 400
                <if test="(type4 != null and type4 != 0)">
					 <choose>
					 	<when test="type4 == 100">
					 		AND ch.resno IS NOT NULL
					 	</when>
					 	<when test="type4 == 200">
					 		AND ch.resno IS NULL
					 	</when>
					 </choose>
				</if>
                ORDER BY a.RDATE DESC, a.START_TIME DESC
		    )cc
		)
		WHERE rn BETWEEN #{startRow} AND #{endRow} 
	</select>

</mapper>