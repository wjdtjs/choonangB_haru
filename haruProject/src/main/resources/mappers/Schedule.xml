<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.haruProject.ScheduleMapper">
	<select id="HJSelectScheduleList" resultType="Schedule">
		SELECT sd.*, cm.content sch_content, ad.aname
		FROM schedule sd
		JOIN common cm ON sd.schtype_bcd = cm.bcd AND sd.schtype_mcd = cm.mcd
		LEFT JOIN admin ad ON sd.ano = ad.ano
		WHERE cm.mcd IN (100,300)
	</select>
	
	<select id="HJSelectSchtype" resultType="Common">
		SELECT *
		FROM common
		WHERE bcd = 600 AND MCD !=999
	</select>
	
 	<select id="HJGetDocOffInfo" resultType="ScheRegularOff">
 	<![CDATA[
		SELECT t1.ano, t1.nowoff, t2.newoff
		FROM (
		    SELECT ano, schdate as nowoff, 
		           rank() over(partition by ano order by schdate desc) as rn
		    FROM schedule
		    WHERE schdate < sysdate
		) t1
		LEFT JOIN (
		    SELECT *
		    FROM (
		        SELECT ano, schdate as newoff,
		               rank() over(partition by ano order by schdate) as rn
		        FROM schedule
		        WHERE schdate > sysdate
		    ) sub_t2
		    WHERE sub_t2.rn = 1
		) t2
		ON t1.ano = t2.ano
		WHERE t1.rn = 1
		AND t1.ano IS NOT NULL
		]]>
	</select>
	
	<select id="HJGetDocOffdays" parameterType="Map" resultType="java.util.Date">
	<if test="(regOffnfo.newoff == null) or (regOffnfo.newoff gt after2m)">
		<![CDATA[
			SELECT  nowoff + (level - 1) *7
			FROM (
	            SELECT *
	            FROM docoffinfo
	            WHERE ano = #{regOffnfo.ano}
	            )
			connect by nowoff + (level - 1) *7  <= #{after2m}
		]]>
	</if>
	<if test="(regOffnfo.newoff != null) and (regOffnfo.newoff lt after2m)">
		<![CDATA[
			SELECT  nowoff + (level - 1) *7
			FROM    (
                SELECT *
                FROM docoffinfo
                WHERE ano = #{regOffnfo.ano}
                )
			connect by nowoff + (level - 1) *7 <= newoff
			UNION
			SELECT  newoff + (level - 1) *7
			FROM    (
                SELECT *
                FROM docoffinfo
                WHERE ano = #{regOffnfo.ano}
                )
			connect by newoff + (level - 1) *7 <= #{after2m}
		]]>
	</if>
	</select>
	
	<select id="HJDocRegOffs" resultType="schedule">
	<![CDATA[
		SELECT sd.*, cm.content sch_content, ad.aname
		FROM schedule sd
		JOIN common cm ON sd.schtype_bcd = cm.bcd AND sd.schtype_mcd = cm.mcd
		LEFT JOIN admin ad ON sd.ano = ad.ano
		WHERE cm.mcd = 200 AND sd.schdate < sysdate
	]]>
	</select>
</mapper>