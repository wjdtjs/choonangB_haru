<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.haruProject.ScheduleMapper">
	<select id="HJSelectScheduleList" parameterType="java.lang.String" resultType="Schedule">
		SELECT sd.*, cm.content sch_content, ad.aname
		FROM schedule sd
		JOIN common cm ON sd.schtype_bcd = cm.bcd AND sd.schtype_mcd = cm.mcd
		LEFT JOIN admin ad ON sd.ano = ad.ano
		WHERE cm.mcd IN (100,300)
		AND
		<if test="current == null">
			sd.schdate LIKE to_char(sysdate,'yy/mm') || '%'
		</if>
		<if test="current != null">
			sd.schdate LIKE #{current} || '%'
		</if>
	</select>
	
	<select id="HJRegScheduleList" parameterType="java.lang.String" resultType="schedule">
	<![CDATA[
		SELECT *
		FROM(
				SELECT sd.*, cm.content sch_content, ad.aname,
						ROW_NUMBER() OVER (PARTITION BY sd.ano ORDER BY sd.schdate DESC) AS rn
				FROM schedule sd
				JOIN common cm ON sd.schtype_bcd = cm.bcd AND sd.schtype_mcd = cm.mcd
				LEFT JOIN admin ad ON sd.ano = ad.ano
				WHERE cm.mcd = 200
				AND sd.schdate < #{currentStart}
			) t
		where t.rn in (1,2)
	]]>
	</select>
	
	<select id="HJSelectSchtype" resultType="Common">
		SELECT *
		FROM common
		WHERE bcd = 600 AND MCD !=999
	</select>
	
 	<select id="HJGetChangedOff" parameterType="Schedule" resultType="java.util.Date">
 	<![CDATA[
		SELECT schdate as newoff
		FROM (
    		SELECT schdate
    		FROM schedule
    		WHERE schtype_mcd = #{schtype_mcd}
      		AND ano = #{ano}
      		AND schdate > #{schdate}
    		ORDER BY schdate ASC
		)
		WHERE ROWNUM = 2;



		]]>
	</select>
	
	<select id="HJGetDocOffdays" parameterType="Map" resultType="java.lang.String">
	<if test="(sche.newoff == null) or (sche.newoff gt currentEnd)">
		<![CDATA[
			SELECT  schdate + (level - 1) *7
			FROM (
	            SELECT *
	            FROM schedule
	            WHERE schno = #{sche.schno}
	            )
			connect by schdate + (level - 1) *7  < #{currentEnd}
		]]>
	</if>
	<if test="(sche.newoff != null) and (sche.newoff lt currentEnd)">
		<![CDATA[
			SELECT  schdate + (level - 1) *7
			FROM    (
                SELECT *
                FROM schedule
                WHERE schno = #{sche.schno}
                )
			connect by schdate + (level - 1) *7 <= #{sche.newoff}
			UNION
			SELECT  #{sche.newoff} + (level - 1) *7
			FROM    (
                SELECT *
                FROM schedule
                WHERE schno = #{sche.schno}
                )
			connect by #{sche.newoff} + (level - 1) *7 < #{currentEnd}
		]]>
	</if>
	</select>
	
</mapper>